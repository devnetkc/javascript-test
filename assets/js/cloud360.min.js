import*as cloud360Types from"./cloud360-types.js";import"./cloud360-view.js";import{RenderView}from"./cloud360-view.js";const Employees=[{internalid:"1",name:"Abe Anderson",email:"aanderson@javascript.com",birthdate:"9/25/1974",supervisor:"3","2012 Revenue":"100000.00","2013 Revenue":"0.00"},{internalid:"2",name:"Bob Benson",email:"bbenson@javascript.com",birthdate:"7/13/1972",supervisor:"3","2012 Revenue":"150000.00","2013 Revenue":"0.00"},{internalid:"3",name:"Chelsea Chastain",email:"cchastain@javascript.com",birthdate:"5/7/1968",supervisor:"","2012 Revenue":"375000.00","2013 Revenue":"0.00"},{internalid:"4",name:"Dwight Dwyer",email:"ddwyer@javascript.com",birthdate:"8/23/1982",supervisor:"3","2012 Revenue":"125000.00","2013 Revenue":"0.00"},{internalid:"5",name:"Eathon Eckhart",email:"eeckhart@javascript.com",birthdate:"11/28/1970",supervisor:"","2012 Revenue":"200000.00","2013 Revenue":"0.00"}],Revenue={2013:[{type:"invoice",customer:"Franklin",Employee:"1",amount:"50000.00",saledate:"9/21/2013"},{type:"invoice",customer:"Franklin",Employee:"1",amount:"20000.00",saledate:"9/23/2013"},{type:"invoice",customer:"Gabby",Employee:"1",amount:"25000.00",saledate:"8/11/2013"},{type:"invoice",customer:"Harry",Employee:"1",amount:"30000.00",saledate:"5/13/2013"},{type:"invoice",customer:"Ingrid",Employee:"2",amount:"75000.00"},{type:"invoice",customer:"Franklin",Employee:"1",amount:"40000.00",saledate:"10/2/2013"},{type:"invoice",customer:"Jacob",Employee:"2",amount:"60000.00",saledate:"11/1/2013"},{type:"invoice",customer:"Kelly",Employee:"4",amount:"30000.00",saledate:"11/21/2013"},{type:"invoice",customer:"Lamar",Employee:"4",amount:"40000.00",saledate:"12/12/2013"},{type:"invoice",customer:"Mary",Employee:"4",amount:"20000.00",saledate:"10/3/2013"},{type:"invoice",customer:"Nicole",Employee:"4",amount:"70000.00",saledate:"12/13/2013"},{type:"invoice",customer:"Oscar",Employee:"5",amount:"75000.00",saledate:"2/10/2013"},{type:"invoice",customer:"Patrick",Employee:"5",amount:"80000.00"},{type:"invoice",customer:"Quin",Employee:"5",amount:"60000.00",saledate:"7/23/2013"},{type:"invoice",customer:"Rachel",Employee:"5",amount:"100000.00",saledate:"12/28/2013"}]},CommissionRules=[{employee:"1",percentage:"15%",bonus:"2000.00"},{employee:"2",percentage:"10%",bonus:"3000.00"},{employee:"3",percentage:"7.5%",bonus:"5000.00"},{employee:"4",percentage:"10%",bonus:"3000.00"},{employee:"5",percentage:"10%",bonus:"3000.00"}],UpdateEmpRecs=async()=>{const CurDate=new Date("1/1/2014"),CurYear=CurDate.getFullYear(),CurrCommYear=CurYear-1,PrevCommYearName=`${CurYear-2} Revenue`,CurrCommYearName=`${CurrCommYear} Revenue`,CurMonth=CurDate.getMonth()+1,Current={CurDate:CurDate,CurMonth:CurMonth,CurYear:CurYear,PrevCommYearName:PrevCommYearName,CurrCommYearName:CurrCommYearName,CurrCommYear:CurrCommYear},ManagerSaleTotals={3:{amount:0}},Questions=[{internalid:0,question:"Q1",title:"Days to Birthday",view:{}},{internalid:1,question:"Q2",title:"Best Customer",view:{}},{internalid:2,question:"Q3P1",title:`${CurrCommYearName} Totals`,view:{}},{internalid:3,question:"Q3P2",title:`${CurrCommYearName} Manager Totals`,view:{}},{internalid:4,question:"Q4",title:`${CurrCommYearName} Commissions`,view:{}},{internalid:5,question:"Q5P1",title:"Days Since Last Sale",view:{}},{internalid:5,question:"Q5P2",title:"Lowest Performing Customer",view:{}}];let expand=!0;for(const Question of Questions)Question.view=new RenderView(Question,`#question-${Question.question}`,"#JSTest2022"),Question.view.addAccordionCard(Question,expand),expand=!1;for(const Emp of Employees)try{const EmpSales=Revenue[CurrCommYear].filter(sale=>sale.Employee==Emp.internalid),Results=await Promise.all([Q1_CalcDaysToBDay(Emp,Current),Q2_SetBestCustomer(EmpSales)]);Emp.daystobday=Results[0],Emp.bestcustomer=Results[1],Q3_UpdateSalesTotals(CurrCommYearName,EmpSales,Emp),Q3P2_UpdateSalesTotals(ManagerSaleTotals,Current);const Supervisor=Emp.supervisor;""!==Supervisor&&(ManagerSaleTotals[Supervisor].amount+=Number(Emp[CurrCommYearName])),Q4_SetCommissions(Emp,Current),Q5P1_DaysSinceSale(Emp,Current),Emp.worstperforming=await Q2_SetBestCustomer(EmpSales,!0)}catch(err){}Questions.forEach(question=>question.view.render(Employees,question))},Q5P1_DaysSinceSale=(emp,Current)=>{const LastSaleDate=Revenue[Current.CurrCommYear].reduce((prevDate,curDate)=>{if(emp.internalid!==curDate.Employee)return prevDate;const SaleDate=new Date(curDate.saledate);return{saledate:prevDate.saledate>SaleDate?prevDate.saledate:SaleDate}},{saledate:new Date(Current.PrevCommYearName)}),PrevSaleDate=LastSaleDate.saledate,DaysSinceSale=Math.floor((Current.CurDate-PrevSaleDate)/864e5);emp.dayssincesale=DaysSinceSale||"N/A",emp.lastsaledate=emp.dayssincesale.toString().startsWith("N/A")?emp.dayssincesale:PrevSaleDate.toLocaleDateString()},Q4_SetCommissions=(emp,Current)=>{const EmpCommissionRules=CommissionRules.filter(rule=>rule.employee==emp.internalid)[0],CommPercent=EmpCommissionRules.percentage.endsWith("%")?EmpCommissionRules.percentage.replace(/%/g,""):EmpCommissionRules.percentage,BonusQualifies=emp[Current.CurrCommYearName]-emp[Current.PrevCommYearName]>0;emp.commission=emp[Current.CurrCommYearName]*(CommPercent/100),BonusQualifies&&(emp.commission+=Number(EmpCommissionRules.bonus)),emp.commission=emp.commission.toFixed(2)},Q3P2_UpdateSalesTotals=(managerSaleTotals,Current)=>{const Managers=Employees.filter(emp=>{for(const Manager in managerSaleTotals){if(!managerSaleTotals.hasOwnProperty(Manager))return!1;if(""===emp.supervisor)return!0}});Managers.forEach(manager=>{const ManagerId=manager.internalid;managerSaleTotals.hasOwnProperty(ManagerId)&&(manager[Current.CurrCommYearName]=managerSaleTotals[ManagerId].amount.toFixed(2),Q4_SetCommissions(manager,Current))})},Q3_UpdateSalesTotals=(year,sales,emp)=>(emp[year]=sales.reduce((prevSale,curSale)=>({amount:prevSale.amount?Number(prevSale.amount)+Number(curSale.amount):Number(curSale.amount)}),{amount:0}).amount.toFixed(2),emp[year]),Q2_SetBestCustomer=async(empSales,worst=!1)=>new Promise((resolve,reject)=>{try{if(empSales.length<=0)return resolve({customer:"N/A",totalsales:0});const CustomerSales={};for(const Sale of empSales){const UpdateObject={customer:Sale.customer,amount:Sale.amount};void 0===CustomerSales[Sale.customer]&&(CustomerSales[Sale.customer]=[]),CustomerSales[Sale.customer].push(UpdateObject)}const CustomerSaleTotals=[];for(const Customer in CustomerSales){if(!CustomerSales.hasOwnProperty(Customer))continue;const CustomerSaleTotal=CustomerSales[Customer].reduce((prevTrans,curTrans)=>{try{if(0===prevTrans)return curTrans;const CustomerTotals=prevTrans.customer===curTrans.customer?Number(prevTrans.amount)+Number(curTrans.amount):Number(curTrans.amount);return{customer:curTrans.customer,amount:CustomerTotals}}catch(err){}},0);CustomerSaleTotals.push(CustomerSaleTotal)}const HighLowCustomer=CustomerSaleTotals.reduce((prevTrans,curTrans)=>{if(0===prevTrans.amount)return curTrans;const MaxNum=Math.max(Number(prevTrans.amount),Number(curTrans.amount));return worst?MaxNum==curTrans.amount?prevTrans:curTrans:MaxNum==curTrans.amount?curTrans:prevTrans},{amount:0});if(worst)return resolve({name:HighLowCustomer.customer,totalsales:HighLowCustomer.amount});resolve({name:HighLowCustomer.customer,totalsales:HighLowCustomer.amount})}catch(err){reject(err)}}),Q1_CalcDaysToBDay=async(emp,Current)=>{const BirthDate=new Date(emp.birthdate),BirthDay=BirthDate.getDate(),BirthMonth=BirthDate.getMonth()+1,NextBDayYear=BirthMonth>Current.CurMonth?Current.CurYear:Current.CurYear+1,NextBDay=new Date(`${BirthMonth}/${BirthDay}/${NextBDayYear}`);return Math.ceil((NextBDay.getTime()-Current.CurDate.getTime())/864e5)},RenderResults=(content,selector)=>{try{if("complete"===document.readyState)return $(selector).html(JSON.stringify(content,null,"\t"));$(document).ready((function(){$(selector).html(JSON.stringify(content,null,"\t"))}))}catch(err){}};export const init=async(raw=!1)=>{try{if(await UpdateEmpRecs(),raw)return JSON.stringify(Employees);RenderResults(Employees,"pre#pre1")}catch(err){}};